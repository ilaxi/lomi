{% for post in posts %}
<article class="post">
    <div class="post-header">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
            <div style="display: flex; align-items: center;">
                <a href="{% url 'profile' username=post.user.username %}" style="text-decoration: none; color: inherit; display: flex; align-items: center;">
                    <img src="{{ post.user.avatar }}" alt="{{ post.user.username }}" class="avatar">
                    <strong>{{ post.user.username }}</strong>
                </a>
                <span style="margin-left: 10px; font-size: 0.8em; color: #8899aa;">{{ post.get_relative_time }}</span>
            </div>
            {% if request.user == post.user %}
            <div class="post-menu" style="position: relative;">
                <button onclick="togglePostMenu({{ post.id }})" class="menu-btn" style="background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 20px;">â‹®</button>
                <div id="postMenu{{ post.id }}" class="post-menu-dropdown" style="display: none; position: absolute; right: 0; top: 100%; background: var(--nav-bg); border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.0); z-index: 1000;">
                    <button onclick="editPost({{ post.id }})" style="display: block; width: 100%; padding: 8px 15px; border: none; background: none; color: var(--text-color); cursor: pointer; text-align: left;">Editar</button>
                    <button onclick="deletePost({{ post.id }})" style="display: block; width: 100%; padding: 8px 15px; border: none; background: none; color: #ff4444; cursor: pointer; text-align: left;">Borrar</button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="post-content" id="postContent{{ post.id }}">
        {{ post.content }}
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="Post image" class="post-image">
        {% endif %}
    </div>
    <div class="post-actions">
        <button class="action-btn like-btn {% if request.user in post.likes.all %}liked{% endif %}" data-post-id="{{ post.id }}">
            â¤ï¸ <span class="likes-count">{{ post.get_likes_count }}</span>
        </button>
        <button class="action-btn">ğŸ”„ Repost</button>
        <a href="{% url 'post_detail' post.id %}" class="action-btn">
            ğŸ’¬ {{ post.get_comments_count }}
        </a>
    </div>
</article>
{% endfor %}

<script>
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.post-menu')) {
            document.querySelectorAll('.post-menu-dropdown').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });

    function togglePostMenu(postId) {
        const menu = document.getElementById(`postMenu${postId}`);
        document.querySelectorAll('.post-menu-dropdown').forEach(m => {
            if (m !== menu) m.style.display = 'none';
        });
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }

    function editPost(postId) {
        const contentDiv = document.getElementById(`postContent${postId}`);
        const currentContent = contentDiv.querySelector('p') ? contentDiv.querySelector('p').textContent : contentDiv.childNodes[0].textContent.trim();
        
        const textarea = document.createElement('textarea');
        textarea.value = currentContent;
        textarea.style.width = '100%';
        textarea.style.minHeight = '100px';
        textarea.style.background = '#ffffff20';
        textarea.style.border = 'none';
        textarea.style.padding = '10px';
        textarea.style.borderRadius = '5px';
        textarea.style.color = 'var(--text-color)';
        textarea.style.resize = 'vertical';

        const saveButton = document.createElement('button');
        saveButton.textContent = 'Guardar';
        saveButton.style.background = '#00b74a';
        saveButton.style.color = 'white';
        saveButton.style.border = 'none';
        saveButton.style.padding = '8px 15px';
        saveButton.style.borderRadius = '5px';
        saveButton.style.marginTop = '10px';
        saveButton.style.cursor = 'pointer';

        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'Cancelar';
        cancelButton.style.background = '#ff4444';
        cancelButton.style.color = 'white';
        cancelButton.style.border = 'none';
        cancelButton.style.padding = '8px 15px';
        cancelButton.style.borderRadius = '5px';
        cancelButton.style.marginTop = '10px';
        cancelButton.style.marginLeft = '10px';
        cancelButton.style.cursor = 'pointer';

        const buttonContainer = document.createElement('div');
        buttonContainer.appendChild(saveButton);
        buttonContainer.appendChild(cancelButton);

        const originalContent = contentDiv.innerHTML;
        contentDiv.innerHTML = '';
        contentDiv.appendChild(textarea);
        contentDiv.appendChild(buttonContainer);

        saveButton.onclick = function() {
            const newContent = textarea.value;
            fetch(`/post/${postId}/edit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `content=${encodeURIComponent(newContent)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    contentDiv.innerHTML = data.content;
                    document.getElementById(`postMenu${postId}`).style.display = 'none';
                }
            });
        };

        cancelButton.onclick = function() {
            contentDiv.innerHTML = originalContent;
        };

        document.getElementById(`postMenu${postId}`).style.display = 'none';
    }

    function deletePost(postId) {
        if (confirm('Â¿Seguro que lo querÃ©s borrar?')) {
            fetch(`/post/${postId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(() => {
                window.location.reload();
            });
        }
    }
</script>
